#!/bin/bash


CYGWIN=false
if [[ -n "$ZSH_VERSION" ]]; then
	inZsh=true
	eval "function shopt {
		local doNothing
		# turn shopt into nothingness in zsh
	}"
else
	inZsh=false
fi

[[ -f /Cygwin.bat ]] && CYGWIN=true



# If not running interactively, don't do anything
if [[ ! -t 0 ]]; then
	return
fi
#[[ "$-" != *i* ]] && return


umask 0022
IGNOREEOF="3"   # Don't close interactive shell for ^D

function pathadd () {
    if ! echo $PATH | /bin/egrep -q "(^|:)$1($|:)" ; then
       if [ "$2" = "after" ] ; then
          PATH=$PATH:$1
       else
          PATH=$1:$PATH
       fi
    fi
}


# Write a note to the bash history.  -l means 'list histNotes'.
function histNote {
	if [[ "$1" == "-l" ]]; then
		history | egrep -A 2 '#--histNote'
	else
		history -s "#--histNote------------H-I-S-T-N-O-T-E--$(date):"
		history -s "cd $PWD"
		history -s "$@"
		history -s "# . . ."
	fi
}

function histrc {
	# don't put duplicate lines in the history. See bash(1) for more options
	# ... or force ignoredups and ignorespace
	HISTCONTROL=ignoredups:ignorespace


	# append to the history file, don't overwrite it
	shopt -s histappend
	shopt -s histverify # Load history events for editing rather than immediate execution
	# for setting history length see HISTSIZE and HISTFILESIZE in bash(1)
	HISTSIZE=10000
	HISTFILESIZE=20000
	PROMPT_COMMAND='history -n'

	alias hist='history '
	alias hn='histNote '
	alias hl='histNote -l'

}

histrc

TERM=xterm-256color

DEBEMAIL="les.matheson@gmail.com"
DEBFULLNAME="Les Matheson"

# check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.
shopt -s checkwinsize

function ls_aliases {
	# some more ls aliases
	alias ll='ls -alF'
	alias la='ls -A'
	alias l='ls -CF'
	alias l1='ls -1'
	alias lr='ls -lirt'
}

# 'gc' is 'git commit'
function gc {
	if [[ -z $1 ]]; then
		git commit
	else
		git commit -m "$@"
	fi
}


function setup_git_aliases {
	alias gs='git status'
	alias ga='git add'
	alias gp='git push'
	alias gl='git log'
	alias gpull='git pull'
	alias gd='git diff'
	alias gdt='git difftool'
}

function rdp-connect {
	# Base code for connecting to an RDP server with rdesktop
	local xhost=$1
	local xuser=$2
	local xpwd=$3
	rdesktop -u $xuser -p "$xpwd" -g 1366x768 -K -x lan $xhost &
	
}

# Set the terminal title (bash only)
function title {
	echo -ne "\033]0;${1}\007"
}

ls_aliases
setup_git_aliases

[[ -f ~/bin/bash_aliases ]] && source ~/bin/bash_aliases

if $CYGWIN; then
	source ~/bin/cyg/cyg-utils
	alias sudo="$@"
fi

if ! $inZsh; then
	if [ -f /etc/bash_completion ] && ! shopt -oq posix; then
		. /etc/bash_completion
	fi
fi

export EDITOR=$(which vim)
export XEDITOR=$(which gvim 2>/dev/null)
if [[ -z $XEDITOR ]]; then
	XEDITOR=$EDITOR
fi

# disable flow control for terminal:
stty -ixon -ixoff

function raverc_stuff {
	[[ -f ~/.raverc/raverc ]] && { source ~/.raverc/raverc; addpath ~/.raverc; }

	#export SVNDIFF_COMPARETOOL="gvimdiff -f"

	# Added by svnkit installer:
	[[ -f ~/.svnkit ]] &&  source ~/.svnkit
	# Added by rmake-update: 
	[[ -f /opt/devel/rbin/rave.rc ]] && source /opt/devel/rbin/rave.rc
}

#raverc_stuff

[[ -f ~/bin/ssh_aliases ]] && source ~/bin/ssh_aliases

if $CYGWIN; then
    export DISPLAY=:0
	PATH=$HOME/bin/cyg:$PATH
fi

if [[ -d ${HOME}/binl ]]; then
	export PATH="${HOME}/binl:${PATH}"
fi




# xclip should use the X clipboard, oddly enough:
alias xclip='xclip -se c'


# Restart network to fix wifi on Kubuntu roaming:
function wifi-restart {
	echo "Restarting wpa_supplicant and network-manager:"
	sudo killall wpa_supplicant
	sudo service network-manager restart
	while !  ping 8.8.8.8 -c 1; do
		sleep 1
	done
}

# Show ip address of given NIC
function ip-show {
	ip addr show dev $1
}

# If we want a shell to not quit, here's how:
function no-exit {
	alias exit="echo 'Sorry, exit is disabled.  Use \"command exit\" if  serious'"
}
alias exit-force='command exit'

if [[ -f ~/bin/rbuzz_rcd ]]; then
	function tox {
		newDir="$($HOME/bin/rbuzz_rcd $@)"
		if [[ ! -z "$newDir" ]]; then
			pushd $newDir >/dev/null
		fi
		unset newDir
	}
else
	function tox {
		echo "This function only works if ~/bin/rbuzz_rcd is present."
	}
fi


if [[ -f $HOME/binl/.cache-funcs ]]; then
	source $HOME/binl/.cache-funcs
fi

if [[ -f $HOME/binl/mediacracy-funcs ]]; then
	source $HOME/binl/mediacracy-funcs
fi

if  which taskrc-shell &>/dev/null ; then
	source $(which taskrc-shell)
fi

# For transient or uncontrolled shell-startup stuff:
if [[ -f ${HOME}/.bashrc-ext ]]; then
	source ${HOME}/.bashrc-ext
fi

function loadTaskrcs {
	while read line; do
		source $line
	done < <(ls -1 $HOME/.taskrc/* 2>/dev/null)
}

# Mildly cleaner taskrc.  If there's a .taskrc directory in HOME,
# just source everything found there.
if [[ -d $HOME/.taskrc ]]; then
	loadTaskrcs
fi

